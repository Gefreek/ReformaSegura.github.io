<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoreo Real CDMX - Ángel de la Independencia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #0d1117;
            color: white;
            margin: 0;
            padding: 0;
        }
        
        #map-container {
            height: 60vh;
            width: 100%;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
        }
        
        .card {
            background: linear-gradient(145deg, #161b22, #1a2029);
            border-radius: 16px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
            position: relative;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #3b82f6, #10b981);
        }
        
        .affected-street {
            position: relative;
            padding-left: 20px;
        }
        
        .affected-street::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            background-color: #ef4444;
            border-radius: 50%;
        }
    </style>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body class="p-4 md:p-8 min-h-screen">
    <div class="max-w-7xl mx-auto">
        <header class="mb-8 text-center">
            <h1 class="text-4xl md:text-6xl font-extrabold bg-gradient-to-r from-red-500 to-orange-500 bg-clip-text text-transparent mt-4">
                Monitoreo Real CDMX
            </h1>
            <p class="text-lg md:text-xl text-gray-400 mt-2 max-w-3xl mx-auto">
                Datos en tiempo real - Radio 1.5 km del Ángel de la Independencia
                <span id="status-container" class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-green-500 text-white ml-2">
                    <i data-lucide="wifi" class="w-3 h-3 mr-1"></i>
                    <span id="status-text">Conectando...</span>
                </span>
            </p>
            <div class="mt-4">
                <div class="text-lg bg-gray-800 rounded-lg px-4 py-2 inline-block" id="real-time-clock">--:--:--</div>
            </div>
        </header>

        <!-- Banner informativo sobre la megamarcha -->
        <div class="card p-6 mb-6 bg-gradient-to-r from-red-500/20 to-orange-500/20 border border-red-500">
            <div class="flex items-start">
                <div class="mr-4 mt-1">
                    <i data-lucide="alert-triangle" class="w-8 h-8 text-red-400"></i>
                </div>
                <div class="flex-1">
                    <h2 class="text-xl font-bold mb-2">Megamarcha de Transportistas - Miércoles 29 de octubre de 2025</h2>
                    <p class="mb-3">La <strong>Fuerza Amplia de Transportistas (FAT)</strong> realizará una megamarcha y bloqueos masivos exigiendo un aumento en las tarifas del transporte público.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <h3 class="font-semibold mb-2 text-red-300">Detalles de la manifestación:</h3>
                            <ul class="text-sm space-y-1">
                                <li><strong>Horario:</strong> 14:00 - 19:00 horas</li>
                                <li><strong>Recorrido:</strong> Del Monumento a la Revolución al Zócalo Capitalino</li>
                                <li><strong>Inicio:</strong> 15:00 horas desde el Monumento a la Revolución</li>
                                <li><strong>Organizador:</strong> Movimiento "Recuperemos el Régimen de Jubilaciones y Pensiones"</li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="font-semibold mb-2 text-red-300">Vialidades afectadas:</h3>
                            <ul class="text-sm space-y-1">
                                <li class="affected-street">Avenida de la República</li>
                                <li class="affected-street">Paseo de la Reforma</li>
                                <li class="affected-street">Calle Balderas</li>
                                <li class="affected-street">Avenida Juárez</li>
                                <li class="affected-street">Eje Central Lázaro Cárdenas</li>
                                <li class="affected-street">Avenida Hidalgo</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="mt-4 p-3 bg-red-500/20 rounded-lg border border-red-500">
                        <h3 class="font-semibold mb-1 text-red-300">Recomendaciones:</h3>
                        <p class="text-sm">Evite el uso de vehículos particulares en las zonas afectadas. Utilice rutas alternas como Periférico, Circuito Interior o Viaducto Miguel Alemán.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Área de búsqueda -->
        <div class="card p-4 mb-6 bg-blue-500/10 border border-blue-500">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i data-lucide="map-pin" class="w-5 h-5 text-blue-400"></i>
                    <div>
                        <p class="font-semibold">Área de Monitoreo: 1.5 km alrededor del Ángel</p>
                        <p class="text-sm text-gray-400">Incluye: Reforma, Zona Rosa, Condesa, Juárez</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-sm font-mono">19.4269, -99.1678</p>
                    <p class="text-xs text-gray-400">Coordenadas exactas</p>
                </div>
            </div>
        </div>

        <div class="card p-6 mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-white flex items-center">
                <i data-lucide="activity" class="w-6 h-6 mr-2 text-red-400"></i>
                Estado del Área - Tiempo Real
            </h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="bg-gradient-to-br from-red-500 to-red-600 p-4 rounded-xl text-white">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-sm opacity-90">Incidentes Activos</p>
                            <p class="text-2xl font-bold" id="active-count">0</p>
                        </div>
                        <i data-lucide="alert-triangle" class="w-8 h-8"></i>
                    </div>
                </div>
                <div class="bg-gradient-to-br from-orange-500 to-orange-600 p-4 rounded-xl text-white">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-sm opacity-90">Reportes Ciudadanos</p>
                            <p class="text-2xl font-bold" id="reports-count">0</p>
                        </div>
                        <i data-lucide="users" class="w-8 h-8"></i>
                    </div>
                </div>
                <div class="bg-gradient-to-br from-blue-500 to-blue-600 p-4 rounded-xl text-white">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-sm opacity-90">Fuentes Activas</p>
                            <p class="text-2xl font-bold" id="sources-count">0</p>
                        </div>
                        <i data-lucide="radio" class="w-8 h-8"></i>
                    </div>
                </div>
                <div class="bg-gradient-to-br from-green-500 to-green-600 p-4 rounded-xl text-white">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-sm opacity-90">Última Actualización</p>
                            <p class="text-lg font-bold" id="last-update">--:--</p>
                        </div>
                        <i data-lucide="clock" class="w-8 h-8"></i>
                    </div>
                </div>
            </div>
        </div>

        <div id="map-container" class="mb-8">
            <div id="map" class="w-full h-full"></div>
        </div>

        <section class="card p-6">
            <h2 class="text-2xl font-semibold mb-4 text-white flex items-center">
                <i data-lucide="alert-circle" class="w-6 h-6 mr-2 text-orange-400"></i>
                Reportes Reales del Área
                <span class="absolute top-0 right-0 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs -mt-2 -mr-2" id="total-count">0</span>
            </h2>
            <div id="reports-list" class="space-y-4">
                <div class="text-center py-8">
                    <i data-lucide="satellite" class="w-16 h-16 text-blue-400 mx-auto mb-4"></i>
                    <p class="text-gray-400" id="loading-text">Conectando a fuentes de datos reales...</p>
                    <p class="text-gray-500 text-sm mt-2" id="loading-subtext">Buscando en radio de 1.5 km del Ángel</p>
                </div>
            </div>
        </section>

        <!-- Fuentes de datos reales -->
        <div class="card p-4 mt-8">
            <h3 class="text-lg font-semibold mb-3 text-white">Fuentes de Datos Reales</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                <div class="flex items-center space-x-2 p-3 bg-blue-500/20 rounded-lg border border-blue-500">
                    <i data-lucide="map" class="w-4 h-4 text-blue-400"></i>
                    <span>OpenStreetMap - Datos de construcción</span>
                </div>
                <div class="flex items-center space-x-2 p-3 bg-green-500/20 rounded-lg border border-green-500">
                    <i data-lucide="rss" class="w-4 h-4 text-green-400"></i>
                    <span>Google News CDMX - Noticias locales</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== CONFIGURACIÓN REAL =====
        const ANGEL_COORDS = [19.4269, -99.1678];
        const SEARCH_RADIUS = 1.5; // 1.5 km
        let map;
        let markers = [];
        let affectedStreetsLayer;

        // Coordenadas aproximadas de las calles afectadas
        const AFFECTED_STREETS = [
            { name: "Avenida de la República", coords: [[19.4365, -99.1540], [19.4350, -99.1530]] },
            { name: "Paseo de la Reforma", coords: [[19.4320, -99.1540], [19.4320, -99.1490], [19.4310, -99.1470], [19.4290, -99.1450]] },
            { name: "Calle Balderas", coords: [[19.4330, -99.1480], [19.4300, -99.1480]] },
            { name: "Avenida Juárez", coords: [[19.4320, -99.1490], [19.4320, -99.1470]] },
            { name: "Eje Central Lázaro Cárdenas", coords: [[19.4340, -99.1470], [19.4300, -99.1470]] },
            { name: "Avenida Hidalgo", coords: [[19.4360, -99.1470], [19.4340, -99.1470]] }
        ];

        // ===== APIS REALES =====
        const REAL_APIS = {
            // OpenStreetMap - Datos reales de construcción
            osm: async () => {
                try {
                    const response = await fetch('https://overpass-api.de/api/interpreter', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: `data=[out:json][timeout:30];
                        (
                            way(around:${SEARCH_RADIUS * 1000},${ANGEL_COORDS[0]},${ANGEL_COORDS[1]})[construction];
                            way(around:${SEARCH_RADIUS * 1000},${ANGEL_COORDS[0]},${ANGEL_COORDS[1]})[highway][service~"emergency"];
                            node(around:${SEARCH_RADIUS * 1000},${ANGEL_COORDS[0]},${ANGEL_COORDS[1]})[emergency];
                        );
                        out body; >; out skel qt;`
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        return parseOSMData(data);
                    }
                } catch (error) {
                    console.log('OSM API error:', error);
                }
                return [];
            },

            // Google News RSS para CDMX
            news: async () => {
                try {
                    const response = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent('https://news.google.com/rss/search?q=CDMX+protesta+manifestación+bloqueo&hl=es-419&gl=MX&ceid=MX:es-419')}`);
                    if (response.ok) {
                        const data = await response.json();
                        return parseNewsData(data);
                    }
                } catch (error) {
                    console.log('News API error:', error);
                }
                return [];
            }
        };

        // ===== INICIALIZACIÓN =====
        function initializeApp() {
            initMap();
            updateClock();
            setInterval(updateClock, 1000);
            loadRealData();
        }

        // ===== CARGA DE DATOS REALES =====
        async function loadRealData() {
            updateStatus('Consultando fuentes reales...', 'loading');
            updateLoadingText('Buscando datos en 1.5 km del Ángel', 'OpenStreetMap + Google News');
            
            try {
                const [osmData, newsData] = await Promise.all([
                    REAL_APIS.osm(),
                    REAL_APIS.news()
                ]);

                const allData = [...osmData, ...newsData];
                processRealData(allData);
                updateStatus(`${allData.length} elementos encontrados`, 'success');
                
            } catch (error) {
                console.error('Error:', error);
                updateStatus('Error de conexión', 'error');
                showNoDataMessage();
            }
        }

        // ===== PARSERS DE DATOS REALES =====
        function parseOSMData(data) {
            const incidents = [];
            
            if (data.elements) {
                data.elements.forEach(element => {
                    if (element.tags) {
                        let description = '';
                        let severity = 'medium';
                        
                        if (element.tags.construction) {
                            description = `Construcción: ${element.tags.construction}`;
                            severity = 'medium';
                        } else if (element.tags.emergency) {
                            description = `Servicio de emergencia: ${element.tags.emergency}`;
                            severity = 'high';
                        } else if (element.tags.service === 'emergency') {
                            description = 'Vía de servicio de emergencia';
                            severity = 'medium';
                        }
                        
                        if (description) {
                            incidents.push({
                                id: `osm-${element.id}`,
                                type: 'infraestructura',
                                location: element.tags.name || 'Vía pública',
                                description: description,
                                source: 'OpenStreetMap',
                                severity: severity,
                                timestamp: new Date().toISOString(),
                                coordinates: [element.lat, element.lon],
                                confirmed: true,
                                realTime: true
                            });
                        }
                    }
                });
            }
            
            return incidents;
        }

        function parseNewsData(data) {
            const incidents = [];
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            
            if (data.items) {
                data.items.forEach(item => {
                    const newsDate = new Date(item.pubDate).toISOString().split('T')[0];
                    
                    // Solo noticias de hoy
                    if (newsDate === today) {
                        // Filtrar por ubicaciones cerca del Ángel
                        const text = (item.title + ' ' + item.description).toLowerCase();
                        const locations = ['reforma', 'angel', 'independencia', 'zona rosa', 'condesa', 'juárez', 'roma'];
                        
                        if (locations.some(location => text.includes(location))) {
                            incidents.push({
                                id: `news-${item.guid}`,
                                type: 'noticia',
                                location: 'CDMX Centro',
                                description: item.title,
                                source: item.source?.name || 'Google News',
                                severity: 'medium',
                                timestamp: item.pubDate,
                                coordinates: getRandomNearbyCoords(),
                                confirmed: true,
                                realTime: true,
                                url: item.link
                            });
                        }
                    }
                });
            }
            
            return incidents;
        }

        function getRandomNearbyCoords() {
            // Generar coordenadas dentro del radio de 1.5 km
            const radius = SEARCH_RADIUS / 111.32; // Grados aproximadamente
            const angle = Math.random() * 2 * Math.PI;
            const distance = Math.random() * radius;
            
            return [
                ANGEL_COORDS[0] + Math.cos(angle) * distance,
                ANGEL_COORDS[1] + Math.sin(angle) * distance
            ];
        }

        // ===== PROCESAMIENTO =====
        function processRealData(data) {
            updateCounters(data);
            updateRealMap(data);
            updateRealList(data);
            updateUI(data);
        }

        // ===== INTERFAZ =====
        function updateStatus(message, type = 'success') {
            const statusElement = document.getElementById('status-text');
            const statusContainer = document.getElementById('status-container');
            
            if (statusElement) statusElement.textContent = message;
            
            const colors = {
                loading: 'bg-yellow-500',
                success: 'bg-green-500',
                error: 'bg-red-500'
            };
            
            if (statusContainer) {
                statusContainer.className = `inline-flex items-center px-3 py-1 rounded-full text-sm ${colors[type]} text-white ml-2`;
            }
        }

        function updateLoadingText(mainText, subText) {
            const mainElement = document.getElementById('loading-text');
            const subElement = document.getElementById('loading-subtext');
            
            if (mainElement) mainElement.textContent = mainText;
            if (subElement) subElement.textContent = subText;
        }

        function updateCounters(data) {
            document.getElementById('active-count').textContent = data.length;
            document.getElementById('reports-count').textContent = data.length;
            document.getElementById('total-count').textContent = data.length;
            document.getElementById('sources-count').textContent = new Set(data.map(item => item.source)).size;
            document.getElementById('last-update').textContent = new Date().toLocaleTimeString('es-MX');
        }

        function updateRealMap(data) {
            if (!map) return;
            
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            // Marcador del Ángel
            const angelIcon = L.divIcon({
                html: `<div style="background: #3b82f6; width: 32px; height: 32px; border-radius: 50%; border: 4px solid white; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.5);"></div>`,
                iconSize: [32, 32],
                iconAnchor: [16, 16]
            });

            L.marker(ANGEL_COORDS, { icon: angelIcon })
                .addTo(map)
                .bindPopup('<div class="p-2"><h3 class="font-bold">Ángel de la Independencia</h3><p class="text-sm">Centro del área de monitoreo</p></div>');

            // Dibujar calles afectadas
            if (affectedStreetsLayer) {
                map.removeLayer(affectedStreetsLayer);
            }
            
            affectedStreetsLayer = L.layerGroup().addTo(map);
            
            AFFECTED_STREETS.forEach(street => {
                const polyline = L.polyline(street.coords, {
                    color: '#ef4444',
                    weight: 6,
                    opacity: 0.7,
                    dashArray: '10, 10'
                }).addTo(affectedStreetsLayer);
                
                polyline.bindPopup(`
                    <div class="p-2">
                        <h3 class="font-bold text-red-600">${street.name}</h3>
                        <p class="text-sm">Vialidad afectada por la megamarcha de transportistas</p>
                        <p class="text-xs text-gray-600 mt-1">Horario de afectación: 14:00 - 19:00 hrs</p>
                    </div>
                `);
            });

            // Marcadores de incidentes
            data.forEach(item => {
                const color = item.severity === 'high' ? 'red' : 
                             item.severity === 'medium' ? 'orange' : 'blue';
                
                const icon = L.divIcon({
                    html: `<div style="background: ${color}; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>`,
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                });
                
                const marker = L.marker(item.coordinates, { icon })
                    .addTo(map)
                    .bindPopup(`
                        <div class="p-3 min-w-[280px]">
                            <h3 class="font-bold text-lg mb-2">${item.location}</h3>
                            <p class="text-sm text-gray-700 mb-3">${item.description}</p>
                            <div class="space-y-1 text-xs">
                                <div class="flex justify-between">
                                    <span class="font-semibold">Fuente:</span>
                                    <span>${item.source}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="font-semibold">Tipo:</span>
                                    <span class="capitalize">${item.type}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="font-semibold">Hora:</span>
                                    <span>${new Date(item.timestamp).toLocaleTimeString()}</span>
                                </div>
                            </div>
                        </div>
                    `);
                
                markers.push(marker);
            });
            
            // Ajustar vista para mostrar el área completa
            if (data.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            } else {
                map.setView(ANGEL_COORDS, 15);
            }
        }

        function updateRealList(data) {
            const list = document.getElementById('reports-list');
            if (!list) return;
            
            if (data.length === 0) {
                list.innerHTML = `
                    <div class="text-center p-8 text-gray-400">
                        <i data-lucide="check-circle" class="w-16 h-16 mx-auto mb-4 text-green-400"></i>
                        <p class="text-xl">Sin incidentes reportados</p>
                        <p class="text-sm text-gray-500 mt-2">No se encontraron eventos en el área monitoreada</p>
                        <div class="mt-4 p-4 bg-green-500/20 rounded-lg border border-green-500">
                            <p class="text-green-400 text-sm">Área de 1.5 km alrededor del Ángel</p>
                            <p class="text-green-400 text-sm">Fuentes: OpenStreetMap + Google News</p>
                        </div>
                    </div>
                `;
            } else {
                list.innerHTML = data.map(item => `
                    <div class="p-4 rounded-lg border-l-4 ${
                        item.severity === 'high' ? 'border-red-500 bg-red-500/10' : 
                        item.severity === 'medium' ? 'border-orange-500 bg-orange-500/10' : 
                        'border-blue-500 bg-blue-500/10'
                    }">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center mb-2">
                                    <h3 class="font-semibold text-lg">${item.location}</h3>
                                    <span class="ml-2 px-2 py-1 ${
                                        item.severity === 'high' ? 'bg-red-500' : 
                                        item.severity === 'medium' ? 'bg-orange-500' : 
                                        'bg-blue-500'
                                    } text-white rounded-full text-xs font-medium">
                                        ${item.source}
                                    </span>
                                </div>
                                <p class="text-gray-300">${item.description}</p>
                                <div class="flex items-center mt-2 text-sm text-gray-400">
                                    <i data-lucide="clock" class="w-4 h-4 mr-1"></i>
                                    <span>${new Date(item.timestamp).toLocaleString('es-MX')}</span>
                                    <span class="mx-2">•</span>
                                    <i data-lucide="map-pin" class="w-4 h-4 mr-1"></i>
                                    <span>${item.type}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            
            lucide.createIcons();
        }

        function updateUI(data) {
            updateLoadingText(
                data.length > 0 ? `${data.length} elementos en el área` : 'Monitoreo activo',
                data.length > 0 ? 'Radio de 1.5 km del Ángel' : 'Buscando datos reales'
            );
        }

        function showNoDataMessage() {
            const list = document.getElementById('reports-list');
            if (list) {
                list.innerHTML = `
                    <div class="text-center p-8 text-gray-400">
                        <i data-lucide="wifi-off" class="w-16 h-16 mx-auto mb-4 text-red-400"></i>
                        <p class="text-xl text-red-400">Fuentes no disponibles</p>
                        <p class="text-sm text-gray-500 mt-2">No se pudieron conectar a las APIs en este momento</p>
                    </div>
                `;
                lucide.createIcons();
            }
        }

        function initMap() {
            const mapElement = document.getElementById('map');
            if (!mapElement) return;
            
            map = L.map('map').setView(ANGEL_COORDS, 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            // Dibujar círculo de 1.5 km
            L.circle(ANGEL_COORDS, {
                color: '#3b82f6',
                fillColor: '#3b82f6',
                fillOpacity: 0.1,
                radius: SEARCH_RADIUS * 1000
            }).addTo(map).bindPopup('Área de monitoreo: 1.5 km');
        }

        function updateClock() {
            const clock = document.getElementById('real-time-clock');
            if (clock) {
                clock.textContent = new Date().toLocaleTimeString('es-MX');
            }
        }

        // ===== INICIALIZACIÓN =====
        document.addEventListener('DOMContentLoaded', function() {
            lucide.createIcons();
            initializeApp();
            
            // Actualizar cada 10 minutos
            setInterval(loadRealData, 10 * 60 * 1000);
        });

    </script>
</body>
</html>
